import javafx.application.Application;
import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.geometry.Insets;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

public class AdminMainPanel extends Application {
    private BorderPane root;
    private List<ParkingRecord> parkingRecords = new ArrayList<>();
    @Override
    public void start(Stage primaryStage) {
        primaryStage.setTitle("管理员界面 - 停车管理系统");
        root = new BorderPane();

        // 创建菜单和其他UI组件
        setupUI(primaryStage);
        showParkingStatus();
        primaryStage.setScene(new Scene(root, 800, 600));
        primaryStage.show();
    }

    private void setupUI(Stage primaryStage) {
        // 菜单项
        MenuBar menuBar = new MenuBar();
        Menu viewMenu = new Menu("视图");
        MenuItem viewParkingStatus = new MenuItem("查看车位情况");
        MenuItem viewAllRecords = new MenuItem("查看所有停车记录");
        viewMenu.getItems().addAll(viewParkingStatus, viewAllRecords);

        Menu adminMenu = new Menu("管理");
        MenuItem manageUsers = new MenuItem("管理用户信息");
        MenuItem manageRates = new MenuItem("修改计费单价");
        adminMenu.getItems().addAll(manageUsers, manageRates);

        Menu accountMenu = new Menu("账户");
//        MenuItem myInfo = new MenuItem("个人信息");
        MenuItem logoutMenuItem = new MenuItem("登出");
        logoutMenuItem.setOnAction(event -> logoutAction());

//        accountMenu.getItems().addAll(myInfo,logoutMenuItem);
        accountMenu.getItems().addAll(logoutMenuItem);
        menuBar.getMenus().addAll(viewMenu, adminMenu,accountMenu);
        root.setTop(menuBar);

        // 菜单项事件处理
        viewParkingStatus.setOnAction(e -> showParkingStatus());
        viewAllRecords.setOnAction(e -> showAllParkingRecords());
        manageUsers.setOnAction(e -> manageUserInformation());
        manageRates.setOnAction(e -> changeParkingRates());

    }

    private void logoutAction() {
        // 关闭当前界面
        Stage stage = (Stage) root.getScene().getWindow();
        stage.close();

        // 打开登录界面
        Platform.runLater(() -> {
            try {
                new LoginFrame().start(new Stage()); // 假设LoginFrame是您的登录界面类
            } catch (Exception e) {
                e.printStackTrace();
            }
        });
    }

    /* 显示所有停车记录 */
    public void showAllParkingRecords() {
        System.out.println("显示停车记录");
        // completed_parkings.csv
        CSVManager csvManager = new CSVManager("completed_parkings.csv");
        List<ParkingRecord> records = csvManager.loadParkingRecords("");
        System.out.println(records.size());
        TableView<ParkingRecord> table = new TableView<>();
        ObservableList<ParkingRecord> data = FXCollections.observableArrayList(records);

        // 定义列
        TableColumn<ParkingRecord, String> usernameCol = new TableColumn<>("用户名");
        usernameCol.setCellValueFactory(new PropertyValueFactory<>("username"));

        TableColumn<ParkingRecord, String> startCol = new TableColumn<>("开始时间");
        startCol.setCellValueFactory(new PropertyValueFactory<>("startTime"));

        TableColumn<ParkingRecord, String> endCol = new TableColumn<>("结束时间");
        endCol.setCellValueFactory(new PropertyValueFactory<>("endTime"));

        TableColumn<ParkingRecord, Long> durationCol = new TableColumn<>("停车时长(分钟)");
        durationCol.setCellValueFactory(new PropertyValueFactory<>("durationInMinutes"));

        TableColumn<ParkingRecord, Double> feeCol = new TableColumn<>("停车费用");
        feeCol.setCellValueFactory(new PropertyValueFactory<>("fee"));
//        feeCol.prefWidthProperty().bind(table.widthProperty().multiply(0.2));

        table.getColumns().addAll(usernameCol, startCol, endCol, durationCol, feeCol);
        table.setItems(data);

        // 显示表格
        VBox vbox = new VBox(table);
        Scene scene = new Scene(vbox,800,400);
        Stage stage = new Stage();
        stage.setScene(scene);
        stage.setTitle("停车记录");
        stage.show();

    }

